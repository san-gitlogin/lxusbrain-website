rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the path
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper function to check file size (in bytes)
    function isValidFileSize(maxSizeMB) {
      return request.resource.size < maxSizeMB * 1024 * 1024;
    }

    // Helper function to check content type
    function isValidContentType(allowedTypes) {
      return request.resource.contentType.matches(allowedTypes);
    }

    // ============================================
    // USER FILES - Each user has their own folder
    // ============================================
    match /users/{userId}/{allPaths=**} {
      // Users can read their own files
      allow read: if isOwner(userId);

      // Users can write their own files with size limits
      allow write: if isOwner(userId) && isValidFileSize(500); // 500MB max per file
    }

    // ============================================
    // USER VIDEOS - Specific rules for video uploads
    // ============================================
    match /users/{userId}/videos/{videoId} {
      // Users can read their own videos
      allow read: if isOwner(userId);

      // Users can upload videos (max 500MB, video content type)
      allow create: if isOwner(userId) &&
        isValidFileSize(500) &&
        isValidContentType('video/.*');

      // Users can delete their own videos
      allow delete: if isOwner(userId);

      // No updates to existing videos (upload new instead)
      allow update: if false;
    }

    // ============================================
    // USER THUMBNAILS - Project/video thumbnails
    // ============================================
    match /users/{userId}/thumbnails/{thumbnailId} {
      allow read: if isOwner(userId);

      // Thumbnails max 5MB, image content type
      allow create, update: if isOwner(userId) &&
        isValidFileSize(5) &&
        isValidContentType('image/.*');

      allow delete: if isOwner(userId);
    }

    // ============================================
    // USER AUDIO - Voice samples, audio files
    // ============================================
    match /users/{userId}/audio/{audioId} {
      allow read: if isOwner(userId);

      // Audio files max 50MB
      allow create, update: if isOwner(userId) &&
        isValidFileSize(50) &&
        isValidContentType('audio/.*');

      allow delete: if isOwner(userId);
    }

    // ============================================
    // USER VOICE SAMPLES - For voice cloning
    // ============================================
    match /users/{userId}/voice_samples/{sampleId} {
      allow read: if isOwner(userId);

      // Voice samples max 10MB (6 seconds of audio is small)
      allow create, update: if isOwner(userId) &&
        isValidFileSize(10) &&
        isValidContentType('audio/.*');

      allow delete: if isOwner(userId);
    }

    // ============================================
    // USER EXPORTS - Exported video files
    // ============================================
    match /users/{userId}/exports/{exportId} {
      allow read: if isOwner(userId);

      // Exports created by Cloud Functions or user
      allow create: if isOwner(userId) && isValidFileSize(2000); // 2GB max

      allow delete: if isOwner(userId);

      allow update: if false;
    }

    // ============================================
    // USER PROJECT ASSETS - Fonts, images, etc.
    // ============================================
    match /users/{userId}/assets/{assetId} {
      allow read: if isOwner(userId);

      // Assets max 50MB
      allow create, update: if isOwner(userId) && isValidFileSize(50);

      allow delete: if isOwner(userId);
    }

    // ============================================
    // PUBLIC ASSETS - Shared app assets (read-only)
    // ============================================
    match /public/{allPaths=**} {
      allow read: if true;
      allow write: if false;
    }

    // ============================================
    // TEMP FILES - Temporary processing files
    // ============================================
    match /temp/{userId}/{allPaths=**} {
      allow read, write: if isOwner(userId);
    }
  }
}
